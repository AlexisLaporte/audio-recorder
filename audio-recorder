#!/bin/bash
# audio-recorder - Record, transcribe & summarize audio
# shellcheck disable=SC1091  # Dynamic source paths

set -o pipefail

# ─────────────────────────────────────────────────────────────────────────────
# Load modules
# ─────────────────────────────────────────────────────────────────────────────

SCRIPT_PATH="${BASH_SOURCE[0]}"
# Follow symlinks to find the real script location
while [ -L "$SCRIPT_PATH" ]; do
    SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
    SCRIPT_PATH="$(readlink "$SCRIPT_PATH")"
    [[ $SCRIPT_PATH != /* ]] && SCRIPT_PATH="$SCRIPT_DIR/$SCRIPT_PATH"
done
LIB_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)/lib"

source "$LIB_DIR/utils.sh"
source "$LIB_DIR/config.sh"
source "$LIB_DIR/audio.sh"
source "$LIB_DIR/transcribe.sh"
source "$LIB_DIR/summarize.sh"

# Load user config
load_config

# ─────────────────────────────────────────────────────────────────────────────
# Main
# ─────────────────────────────────────────────────────────────────────────────

show_help() {
    echo -e "${BOLD}audio-recorder${NC} - Record, transcribe & summarize"
    echo ""
    echo "Usage: audio-recorder <command> [options]"
    echo ""
    echo "Commands:"
    echo "  start                  Start recording"
    echo "  stop [--only]          Stop & process (--only skips processing)"
    echo "  stop --comment \"...\"   Stop with context for summary"
    echo "  status                 Show recording status"
    echo "  transcribe [file|folder] Transcribe audio file or folder"
    echo "  summarize [folder]     Generate AI summary"
    echo "  list                   List recordings"
    echo "  open [folder]          Open folder in file manager"
    echo "  setup                  Configure settings"
    echo ""
}

case "$1" in
    start)      cmd_start ;;
    stop)       shift; cmd_stop "$@" ;;
    status)     cmd_status ;;
    transcribe) cmd_transcribe "$2" "$3" ;;
    summarize)  shift; cmd_summarize "$@" ;;
    list|ls)    cmd_list ;;
    open)       cmd_open "$2" ;;
    setup)      setup ;;
    help|--help|-h) show_help ;;
    *)          show_help ;;
esac
