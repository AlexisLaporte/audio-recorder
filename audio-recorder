#!/bin/bash
# audio-recorder - Record, transcribe & summarize audio

set -o pipefail

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Configuration
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

CONFIG_DIR="$HOME/.config/audio-recorder"
CONFIG_FILE="$CONFIG_DIR/config"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

OS="$(uname -s)"
RECORDINGS_DIR="$HOME/Recordings"
PID_FILE="/tmp/audio-recorder.pid"
START_TIME_FILE="/tmp/audio-recorder-start"
FOLDER_FILE="/tmp/audio-recorder-folder"
NAME_FILE="/tmp/audio-recorder-name"

# Load config
[ -f "$CONFIG_FILE" ] && source "$CONFIG_FILE"
mkdir -p "$RECORDINGS_DIR"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Helpers
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# Colors (disabled if not a terminal)
if [ -t 1 ]; then
    RED='\033[0;31m'
    GREEN='\033[0;32m'
    YELLOW='\033[0;33m'
    BLUE='\033[0;34m'
    BOLD='\033[1m'
    DIM='\033[2m'
    NC='\033[0m'
else
    RED='' GREEN='' YELLOW='' BLUE='' BOLD='' DIM='' NC=''
fi

info()    { echo -e "${BLUE}â–¸${NC} $*"; }
success() { echo -e "${GREEN}âœ“${NC} $*"; }
error()   { echo -e "${RED}âœ—${NC} $*" >&2; }
warn()    { echo -e "${YELLOW}!${NC} $*"; }

spinner() {
    local pid=$1
    local msg=$2
    local chars="â ‹â ™â ¹â ¸â ¼â ´â ¦â §â ‡â "
    local i=0
    while kill -0 $pid 2>/dev/null; do
        printf "\r${BLUE}${chars:$i:1}${NC} %s" "$msg"
        i=$(( (i + 1) % 10 ))
        sleep 0.1
    done
    printf "\r"
}

format_duration() {
    local seconds=$1
    if [ $seconds -lt 60 ]; then
        echo "${seconds}s"
    elif [ $seconds -lt 3600 ]; then
        echo "$((seconds / 60))m $((seconds % 60))s"
    else
        echo "$((seconds / 3600))h $((seconds % 3600 / 60))m"
    fi
}

notify() {
    local title="$1"
    local msg="$2"
    case "$OS" in
        Darwin) osascript -e "display notification \"$msg\" with title \"$title\"" 2>/dev/null ;;
        *)      notify-send "$title" "$msg" -i audio-input-microphone 2>/dev/null ;;
    esac
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Setup
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

setup() {
    mkdir -p "$CONFIG_DIR"

    echo -e "${BOLD}audio-recorder setup${NC}"
    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    echo ""

    # HF Token
    local current_token="${HF_TOKEN:-(not set)}"
    [ ${#current_token} -gt 20 ] && current_token="${current_token:0:10}...${current_token: -4}"
    read -p "HuggingFace Token [$current_token]: " new_token
    [ -n "$new_token" ] && HF_TOKEN="$new_token"

    # Recordings directory
    read -p "Recordings directory [$RECORDINGS_DIR]: " new_dir
    [ -n "$new_dir" ] && RECORDINGS_DIR="${new_dir/#\~/$HOME}"

    # Save
    cat > "$CONFIG_FILE" << EOF
HF_TOKEN="$HF_TOKEN"
RECORDINGS_DIR="$RECORDINGS_DIR"
EOF
    chmod 600 "$CONFIG_FILE"
    mkdir -p "$RECORDINGS_DIR"

    echo ""
    success "Config saved to $CONFIG_FILE"
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Audio sources
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

get_sources() {
    case "$OS" in
        Darwin)
            local devices=$(ffmpeg -f avfoundation -list_devices true -i "" 2>&1 | grep -A 100 "audio devices" | grep "^\[")
            MONITOR=$(echo "$devices" | grep -i "blackhole" | head -1 | sed 's/.*\[\([0-9]*\)\].*/\1/')
            MIC=$(echo "$devices" | grep -i "microphone\|macbook" | head -1 | sed 's/.*\[\([0-9]*\)\].*/\1/')
            [ -z "$MIC" ] && MIC="0"
            ;;
        *)
            MONITOR=$(pactl list short sources | grep "monitor" | grep -v "SUSPENDED" | head -1 | cut -f2)
            MIC=$(pactl list short sources | grep "input" | grep -v "SUSPENDED" | head -1 | cut -f2)
            [ -z "$MONITOR" ] && MONITOR=$(pactl list short sources | grep "monitor" | head -1 | cut -f2)
            [ -z "$MIC" ] && MIC=$(pactl list short sources | grep "input" | head -1 | cut -f2)
            ;;
    esac
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Recording
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

is_recording() {
    [ -f "$PID_FILE" ] && kill -0 $(cat "$PID_FILE") 2>/dev/null
}

cmd_start() {
    if is_recording; then
        error "Already recording: $(cat "$NAME_FILE" 2>/dev/null)"
        return 1
    fi

    get_sources

    local name="recording_$(date +%Y%m%d_%H%M%S)"
    local folder="$RECORDINGS_DIR/$name"
    mkdir -p "$folder"

    echo "$folder" > "$FOLDER_FILE"
    echo "$name" > "$NAME_FILE"
    date +%s > "$START_TIME_FILE"

    case "$OS" in
        Darwin)
            if [ -n "$MONITOR" ]; then
                ffmpeg -f avfoundation -i ":$MONITOR" -f avfoundation -i ":$MIC" \
                    -filter_complex "[0:a][1:a]amix=inputs=2:duration=longest[out]" \
                    -map "[out]" -codec:a libmp3lame -q:a 2 \
                    "$folder/audio.mp3" &>/dev/null &
            else
                ffmpeg -f avfoundation -i ":$MIC" -codec:a libmp3lame -q:a 2 \
                    "$folder/audio.mp3" &>/dev/null &
            fi
            ;;
        *)
            ffmpeg -f pulse -i "$MONITOR" -f pulse -i "$MIC" \
                -filter_complex "[0:a][1:a]amix=inputs=2:duration=longest[out]" \
                -map "[out]" -codec:a libmp3lame -q:a 2 \
                "$folder/audio.mp3" &>/dev/null &
            ;;
    esac

    echo $! > "$PID_FILE"

    echo ""
    echo -e "  ${RED}â—${NC} ${BOLD}Recording${NC}"
    echo -e "  ${DIM}$name${NC}"
    echo ""

    notify "Recording started" "$name"
}

cmd_stop() {
    local process_audio=true
    local comment=""

    # Parse args
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --only) process_audio=false; shift ;;
            --comment|-c) comment="$2"; shift 2 ;;
            *) shift ;;
        esac
    done

    if ! is_recording; then
        error "No recording in progress"
        return 1
    fi

    # Stop ffmpeg
    kill $(cat "$PID_FILE") 2>/dev/null
    rm -f "$PID_FILE"

    local name=$(cat "$NAME_FILE" 2>/dev/null)
    local folder=$(cat "$FOLDER_FILE" 2>/dev/null)
    local start_time=$(cat "$START_TIME_FILE" 2>/dev/null)
    local duration=""

    if [ -n "$start_time" ]; then
        local elapsed=$(($(date +%s) - start_time))
        duration=$(format_duration $elapsed)
    fi

    echo ""
    echo -e "  ${GREEN}â– ${NC} ${BOLD}Stopped${NC} ${DIM}($duration)${NC}"
    echo -e "  ${DIM}$folder/audio.mp3${NC}"

    notify "Recording stopped" "$name ($duration)"

    # Process if requested
    if [ "$process_audio" = true ]; then
        echo ""
        echo -e "${BOLD}Processing...${NC}"
        echo ""

        # Transcribe
        if cmd_transcribe "$folder"; then
            # Summarize
            if [ -n "$comment" ]; then
                cmd_summarize "$folder" --comment "$comment"
            else
                cmd_summarize "$folder"
            fi
        fi
    fi
}

cmd_status() {
    if is_recording; then
        local name=$(cat "$NAME_FILE" 2>/dev/null)
        local start_time=$(cat "$START_TIME_FILE" 2>/dev/null)
        local duration=""
        if [ -n "$start_time" ]; then
            local elapsed=$(($(date +%s) - start_time))
            duration=" ($(format_duration $elapsed))"
        fi
        echo -e "${RED}â—${NC} Recording: ${BOLD}$name${NC}$duration"
    else
        echo -e "${DIM}â– ${NC} Not recording"
    fi
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Transcribe
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

cmd_transcribe() {
    if [ -z "$HF_TOKEN" ]; then
        error "HF_TOKEN not set. Run 'audio-recorder setup'"
        return 1
    fi

    local folder="$1"
    local model="${2:-small}"

    # Default to latest recording
    if [ -z "$folder" ]; then
        folder=$(ls -td "$RECORDINGS_DIR"/recording_* 2>/dev/null | head -1)
    fi
    [[ ! "$folder" == /* ]] && folder="$RECORDINGS_DIR/$folder"

    local audio="$folder/audio.mp3"
    if [ ! -f "$audio" ]; then
        error "No audio file: $audio"
        return 1
    fi

    info "Transcribing with WhisperX (model: $model)..."

    # Run whisperx
    whisperx "$audio" \
        --language fr \
        --model "$model" \
        --diarize \
        --hf_token "$HF_TOKEN" \
        --output_dir "$folder" 2>&1 | grep -v "^/\|UserWarning\|^$\|^Traceback\|^  File" || true

    # Cleanup & rename
    rm -f "$folder"/audio.{json,srt,tsv,vtt} 2>/dev/null

    if [ -f "$folder/audio.txt" ]; then
        mv "$folder/audio.txt" "$folder/transcript.txt"
        success "Transcript: $folder/transcript.txt"
        return 0
    else
        error "Transcription failed"
        return 1
    fi
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Summarize
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

cmd_summarize() {
    local folder=""
    local comment=""

    while [[ $# -gt 0 ]]; do
        case "$1" in
            --comment|-c) comment="$2"; shift 2 ;;
            *) folder="$1"; shift ;;
        esac
    done

    # Default to latest recording
    if [ -z "$folder" ]; then
        folder=$(ls -td "$RECORDINGS_DIR"/* 2>/dev/null | head -1)
    fi
    [[ ! "$folder" == /* ]] && folder="$RECORDINGS_DIR/$folder"

    local transcript="$folder/transcript.txt"
    if [ ! -f "$transcript" ]; then
        error "No transcript: $transcript"
        return 1
    fi

    local prompt_file="$SCRIPT_DIR/summarize-prompt.md"
    if [ ! -f "$prompt_file" ]; then
        error "Prompt template not found: $prompt_file"
        return 1
    fi

    info "Summarizing with Claude..."

    # Build prompt
    local prompt=$(cat "$prompt_file")
    [ -n "$comment" ] && prompt="$prompt

## User Context
$comment"
    prompt="$prompt

---

## Transcript

$(cat "$transcript")"

    # Call Claude
    local result=$(claude -p "$prompt" 2>&1)

    local new_name=$(echo "$result" | grep "^FOLDER_NAME:" | tail -1 | sed 's/FOLDER_NAME: *//')
    local summary=$(echo "$result" | sed '/^FOLDER_NAME:/,$d')

    if [ -z "$summary" ]; then
        error "Summarization failed"
        echo "$result"
        return 1
    fi

    echo "$summary" > "$folder/summary.md"
    success "Summary: $folder/summary.md"

    # Preview
    echo ""
    echo -e "${DIM}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
    head -15 "$folder/summary.md"
    echo -e "${DIM}...${NC}"
    echo -e "${DIM}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"

    # Rename
    if [ -n "$new_name" ]; then
        echo ""
        info "Suggested name: ${BOLD}$new_name${NC}"
        read -p "Rename folder? [Y/n] " confirm
        if [[ ! "$confirm" =~ ^[Nn] ]]; then
            local new_folder="$RECORDINGS_DIR/$new_name"
            if [ -d "$new_folder" ]; then
                error "Folder already exists: $new_name"
                return 1
            fi
            mv "$folder" "$new_folder"
            folder="$new_folder"
            success "Renamed to: $new_name"
        fi
    fi

    # Final summary
    echo ""
    echo -e "${GREEN}${BOLD}Done!${NC}"
    echo -e "  ${DIM}$folder${NC}"
    echo -e "  â”œâ”€â”€ audio.mp3"
    echo -e "  â”œâ”€â”€ transcript.txt"
    echo -e "  â””â”€â”€ summary.md"

    notify "Processing complete" "$(basename "$folder")"
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# List & Open
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

cmd_list() {
    echo -e "${BOLD}Recordings${NC} ${DIM}($RECORDINGS_DIR)${NC}"
    echo ""

    local count=0
    for dir in $(ls -td "$RECORDINGS_DIR"/* 2>/dev/null | head -15); do
        [ ! -d "$dir" ] && continue
        local name=$(basename "$dir")
        local icon="  "
        [ -f "$dir/transcript.txt" ] && icon="${YELLOW}ðŸ“${NC}"
        [ -f "$dir/summary.md" ] && icon="${GREEN}âœ“${NC} "
        echo -e "  $icon $name"
        ((count++))
    done

    if [ $count -eq 0 ]; then
        echo -e "  ${DIM}No recordings yet${NC}"
    else
        echo ""
        echo -e "  ${DIM}ðŸ“ transcribed  âœ“ summarized${NC}"
    fi
}

cmd_open() {
    local folder="$1"

    if [ -z "$folder" ]; then
        folder=$(ls -td "$RECORDINGS_DIR"/* 2>/dev/null | head -1)
    fi
    [[ ! "$folder" == /* ]] && folder="$RECORDINGS_DIR/$folder"

    if [ ! -d "$folder" ]; then
        error "Folder not found: $folder"
        return 1
    fi

    case "$OS" in
        Darwin) open "$folder" ;;
        *)      xdg-open "$folder" 2>/dev/null || error "Could not open folder" ;;
    esac
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Main
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

show_help() {
    echo -e "${BOLD}audio-recorder${NC} - Record, transcribe & summarize"
    echo ""
    echo "Usage: audio-recorder <command> [options]"
    echo ""
    echo "Commands:"
    echo "  start                  Start recording"
    echo "  stop [--only]          Stop & process (--only skips processing)"
    echo "  stop --comment \"...\"   Stop with context for summary"
    echo "  status                 Show recording status"
    echo "  transcribe [folder]    Transcribe audio"
    echo "  summarize [folder]     Generate AI summary"
    echo "  list                   List recordings"
    echo "  open [folder]          Open folder in file manager"
    echo "  setup                  Configure settings"
    echo ""
}

case "$1" in
    start)      cmd_start ;;
    stop)       shift; cmd_stop "$@" ;;
    status)     cmd_status ;;
    transcribe) cmd_transcribe "$2" "$3" ;;
    summarize)  shift; cmd_summarize "$@" ;;
    list|ls)    cmd_list ;;
    open)       cmd_open "$2" ;;
    setup)      setup ;;
    help|--help|-h) show_help ;;
    *)          show_help ;;
esac
