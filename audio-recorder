#!/bin/bash
# Audio recorder - captures mic + system audio with transcription

RECORDINGS_DIR="$HOME/Enregistrements"
mkdir -p "$RECORDINGS_DIR"

PID_FILE="/tmp/audio-recorder.pid"

get_sources() {
    MONITOR=$(pactl list short sources | grep "monitor" | grep -v "SUSPENDED" | head -1 | cut -f2)
    MIC=$(pactl list short sources | grep "input" | grep -v "SUSPENDED" | head -1 | cut -f2)
    [ -z "$MONITOR" ] && MONITOR=$(pactl list short sources | grep "monitor" | head -1 | cut -f2)
    [ -z "$MIC" ] && MIC=$(pactl list short sources | grep "input" | head -1 | cut -f2)
}

is_recording() {
    [ -f "$PID_FILE" ] && kill -0 $(cat "$PID_FILE") 2>/dev/null
}

start_recording() {
    if is_recording; then
        echo "âŒ Enregistrement dÃ©jÃ  en cours: $(cat /tmp/audio-recorder-name 2>/dev/null)"
        return 1
    fi

    get_sources

    # Create folder for this recording
    RECORDING_NAME="recording_$(date +%Y%m%d_%H%M%S)"
    RECORDING_FOLDER="$RECORDINGS_DIR/$RECORDING_NAME"
    mkdir -p "$RECORDING_FOLDER"
    RECORDING_FILE="$RECORDING_FOLDER/audio.mp3"

    echo "$RECORDING_FOLDER" > /tmp/audio-recorder-folder
    echo "$RECORDING_NAME" > /tmp/audio-recorder-name

    ffmpeg -f pulse -i "$MONITOR" -f pulse -i "$MIC" \
        -filter_complex "[0:a][1:a]amix=inputs=2:duration=longest[out]" \
        -map "[out]" -codec:a libmp3lame -q:a 2 \
        "$RECORDING_FILE" &>/dev/null &

    echo $! > "$PID_FILE"
    echo "ðŸ”´ Enregistrement dÃ©marrÃ©: $RECORDING_NAME"
    notify-send "ðŸ”´ Enregistrement dÃ©marrÃ©" "$RECORDING_NAME" -i audio-input-microphone 2>/dev/null
}

stop_recording() {
    if [ -f "$PID_FILE" ]; then
        kill $(cat "$PID_FILE") 2>/dev/null
        rm "$PID_FILE"
        RECORDING_NAME=$(cat /tmp/audio-recorder-name 2>/dev/null)
        echo "â¹ Enregistrement terminÃ©: $RECORDING_NAME"
        notify-send "â¹ Enregistrement terminÃ©" "$RECORDING_NAME" -i audio-input-microphone 2>/dev/null
    else
        echo "Aucun enregistrement en cours"
    fi
}

status() {
    if is_recording; then
        echo "ðŸ”´ Enregistrement en cours: $(cat /tmp/audio-recorder-name 2>/dev/null)"
    else
        echo "â¹ Pas d'enregistrement"
    fi
}

transcribe() {
    if [ -z "$HF_TOKEN" ]; then
        echo "âŒ HF_TOKEN non dÃ©fini. Export ton token HuggingFace d'abord."
        return 1
    fi

    local folder="$1"
    local model="${2:-small}"

    # Si pas de dossier spÃ©cifiÃ©, prendre le dernier enregistrement
    if [ -z "$folder" ]; then
        folder=$(ls -td "$RECORDINGS_DIR"/recording_* 2>/dev/null | head -1)
    fi

    # Si c'est juste un nom, construire le chemin complet
    if [[ ! "$folder" == /* ]]; then
        folder="$RECORDINGS_DIR/$folder"
    fi

    local audio_file="$folder/audio.mp3"

    if [ -z "$folder" ] || [ ! -f "$audio_file" ]; then
        echo "âŒ Aucun fichier audio Ã  transcrire"
        return 1
    fi

    echo "ðŸ“ Transcription de $(basename "$folder") avec diarization (modÃ¨le $model)..."

    # Run whisperx with diarization
    stdbuf -oL whisperx "$audio_file" \
        --language fr \
        --model "$model" \
        --diarize \
        --hf_token "$HF_TOKEN" \
        --output_dir "$folder" 2>&1 | grep -v "^/\|UserWarning\|^$"

    # Keep only txt, remove other outputs
    rm -f "$folder"/audio.{json,srt,tsv,vtt} 2>/dev/null

    # Rename to transcript.txt
    if [ -f "$folder/audio.txt" ]; then
        mv "$folder/audio.txt" "$folder/transcript.txt"
        echo "âœ… Transcription terminÃ©e: $folder/transcript.txt"
    else
        echo "âŒ Erreur lors de la transcription"
        return 1
    fi
}

list() {
    echo "ðŸ“ Enregistrements:"
    for dir in $(ls -td "$RECORDINGS_DIR"/recording_* 2>/dev/null | head -10); do
        name=$(basename "$dir")
        has_transcript=""
        [ -f "$dir/transcript.txt" ] && has_transcript=" âœ…"
        echo "  - $name$has_transcript"
    done
}

case "$1" in
    start) start_recording ;;
    stop) stop_recording ;;
    status) status ;;
    transcribe) transcribe "$2" "$3" ;;
    list) list ;;
    *) echo "Usage: audio-recorder {start|stop|status|list|transcribe [dossier] [model]}" ;;
esac
